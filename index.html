<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Molecule Visualizer</title>
  <script defer src="https://3Dmol.org/build/3Dmol-min.js"></script>
  <style>
    html,body{margin:0;font-family:Arial,sans-serif}
    .app{display:grid;grid-template-columns:240px 1fr;column-gap:16px;height:460px}
    .sidebar{background:#f5f5f5;padding:24px 18px;border-radius:10px;display:flex;flex-direction:column}
    .sidebar h2{font-size:18px;margin:0 0 14px}
    .sidebar select{width:100%;padding:8px 10px;font-size:16px;margin-bottom:12px}
    #element-table{width:100%;border-collapse:collapse;font-size:14px;display:none}
    #element-table th,#element-table td{border:1px solid #ccc;padding:4px 6px;text-align:center}
    #element-table th{background:#e8e8e8}
    .viewer-wrap{position:relative;border-radius:10px;overflow:hidden}
    #viewer{position:absolute;inset:0;border:1px solid #ccc;border-radius:10px}
  </style>
</head>
<body>

<div class="app">
  <div class="sidebar">
    <h2>Select a molecule</h2>
    <select id="molecule-select"><option>— loading —</option></select>
    <table id="element-table">
      <thead><tr><th>Element</th><th>Atoms</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="viewer-wrap"><div id="viewer"></div></div>
</div>

<script>
/* -------- discover .mol & .sdf -------- */
async function listMolFiles(){
  const accept = f => f.endsWith('.mol') || f.endsWith('.sdf');

  if(location.hostname.endsWith('.github.io')){
    const owner = location.hostname.split('.')[0];
    const repo  = location.pathname.split('/')[1] || 'madhuri_gowda';
    const api   = `https://api.github.com/repos/${owner}/${repo}/contents/molecules`;
    try{
      const js = await (await fetch(api)).json();
      return js.filter(x=>accept(x.name)).map(x=>x.name);
    }catch(e){}
  }
  try{
    const html = await (await fetch('molecules/')).text();
    return [...html.matchAll(/href="([^"]+\.(?:mol|sdf))"/gi)].map(m=>m[1]);
  }catch(e){}
  return [];
}

/* -------- init viewer ---------- */
window.addEventListener('DOMContentLoaded', async ()=>{

  const sel = document.getElementById('molecule-select');
  const t   = document.getElementById('element-table');
  const tb  = t.querySelector('tbody');
  const v   = $3Dmol.createViewer('viewer',{backgroundColor:'white',antialias:false});

  const files = await listMolFiles();
  sel.innerHTML='<option value="">— Choose —</option>';
  files.forEach(f=>{
    const o=document.createElement('option');
    o.value=f; o.textContent=f.replace(/\.(mol|sdf)$/,'');
    sel.appendChild(o);
  });

  sel.addEventListener('change', async ()=>{
    const file = sel.value;
    v.clear(); t.style.display='none'; tb.innerHTML='';
    if(!file){v.render();return;}

    try{
      const txt = await (await fetch('molecules/'+encodeURIComponent(file))).text();
      const m   = v.addModel(txt,'sdf');          // parse as sdf/mol V2000
      if(!m || !m.selectedAtoms().length) throw new Error('parse-fail');

      v.setStyle({}, {stick:{radius:0.15}});
      v.zoomTo(); v.render();

      /* count atoms */
      const count={};
      m.selectedAtoms({}).forEach(a=>{
        const e=a.elem||a.element||a.atomic; count[e]=(count[e]||0)+1;
      });
      tb.innerHTML = Object.entries(count)
       .sort((a,b)=>a[0].localeCompare(b[0]))
       .map(([e,n])=>`<tr><td>${e}</td><td>${n}</td></tr>`).join('');
      t.style.display='table';

    }catch(err){
      alert('Cannot load '+file+' (must be V2000 mol/sdf).');
      console.error(err);
    }
  });

  window.addEventListener('resize', ()=>v.resize());
});
</script>
</body>
</html>
